name: Sync Research to Notion

on:
  workflow_dispatch:
    inputs:
      company:
        description: 'Company to sync (e.g., livekit.io, 100ms.live, daily.co)'
        required: true
        type: string

jobs:
  sync-to-notion:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install notion-client

      - name: Create sync script
        run: |
          cat > sync_company.py << 'SCRIPT_EOF'
          #!/usr/bin/env python3
          import os
          import sys
          import asyncio
          from notion_client import AsyncClient

          # Configuration
          DATABASE_ID = "2861bdff7e998000a14edb0bf56a75bf"
          NOTION_API_KEY = os.environ.get("NOTION_API_KEY", "")
          COMPANY = sys.argv[1] if len(sys.argv) > 1 else "livekit.io"

          # Company data mapping
          COMPANY_DATA = {
              "livekit.io": {
                  "Company_Name": "LiveKit",
                  "Website": "https://livekit.io",
                  "Linkedin Link": "https://www.linkedin.com/company/livekitco",
                  "Status / Engagement": "Ice Box",
                  "Vertical": "Infrastructure",
                  "ICP": "3",
                  "Product description": "Open-source WebRTC voice-video infrastructure",
                  "ASR provider": ["Deepgram", "Assembly AI", "Speechmatics"],
                  "Nbr of AI/ML/Speech engineer": 15,
                  "Main Office Country": "United States",
              },
              "100ms.live": {
                  "Company_Name": "100ms",
                  "Website": "https://www.100ms.live",
                  "Linkedin Link": "https://www.linkedin.com/company/100mslive",
                  "Status / Engagement": "Ice Box",
                  "Vertical": "Infrastructure",
                  "ICP": "3",
                  "Product description": "Live video API for developers",
                  "ASR provider": ["External service (HIPAA)"],
                  "Nbr of AI/ML/Speech engineer": 10,
                  "Main Office Country": "United States",
              },
              "daily.co": {
                  "Company_Name": "Daily",
                  "Website": "https://www.daily.co",
                  "Linkedin Link": "https://www.linkedin.com/company/daily-co",
                  "Status / Engagement": "Ice Box",
                  "Vertical": "Infrastructure",
                  "ICP": "3",
                  "Product description": "WebRTC APIs and Pipecat framework",
                  "ASR provider": ["Deepgram", "AssemblyAI", "OpenAI Whisper"],
                  "Nbr of AI/ML/Speech engineer": 20,
                  "Main Office Country": "United States",
              },
          }

          async def sync_to_notion():
              if not NOTION_API_KEY:
                  print("‚ùå NOTION_API_KEY not set")
                  sys.exit(1)

              if COMPANY not in COMPANY_DATA:
                  print(f"‚ùå Unknown company: {COMPANY}")
                  print(f"Available: {', '.join(COMPANY_DATA.keys())}")
                  sys.exit(1)

              data = COMPANY_DATA[COMPANY]
              client = AsyncClient(auth=NOTION_API_KEY)

              # Step 1: Search for existing page
              print(f"üîç Searching for existing {data['Company_Name']} page...")
              query = await client.databases.query(
                  database_id=DATABASE_ID,
                  filter={
                      "property": "Website",
                      "url": {"equals": data["Website"]}
                  }
              )

              # Step 2: Prepare properties
              properties = {
                  "Company_Name": {"title": [{"text": {"content": data["Company_Name"]}}]},
                  "Website": {"url": data["Website"]},
                  "Linkedin Link": {"url": data["Linkedin Link"]},
                  "Status / Engagement": {"select": {"name": data["Status / Engagement"]}},
                  "Vertical": {"select": {"name": data["Vertical"]}},
                  "ICP": {"select": {"name": data["ICP"]}},
                  "Product description": {"rich_text": [{"text": {"content": data["Product description"]}}]},
                  "ASR provider": {"multi_select": [{"name": name} for name in data["ASR provider"]]},
                  "Nbr of AI/ML/Speech engineer": {"number": data["Nbr of AI/ML/Speech engineer"]},
                  "Main Office Country": {"rich_text": [{"text": {"content": data["Main Office Country"]}}]},
              }

              # Step 3: Create or update page
              if query["results"]:
                  page_id = query["results"][0]["id"]
                  print(f"‚úÖ Found existing page: {page_id}")
                  response = await client.pages.update(
                      page_id=page_id,
                      properties=properties
                  )
                  print(f"‚úÖ Updated page for {data['Company_Name']}")
              else:
                  print(f"üìù Creating new page...")
                  response = await client.pages.create(
                      parent={"database_id": DATABASE_ID},
                      properties=properties
                  )
                  page_id = response["id"]
                  print(f"‚úÖ Created new page: {page_id}")

              # Step 4: Add content reference
              report_path = f"logs/deep-dive-{COMPANY}-2025-11-06.md"
              await client.blocks.children.append(
                  block_id=page_id,
                  children=[
                      {
                          "object": "block",
                          "type": "paragraph",
                          "paragraph": {
                              "rich_text": [{"type": "text", "text": {"content": f"üìä Full research report: {report_path}"}}]
                          }
                      }
                  ]
              )
              print("‚úÖ Added content reference")

              page_url = f"https://notion.so/{page_id.replace('-', '')}"
              print(f"\nüîó Notion Page: {page_url}")
              print(f"\n‚úÖ Sync complete for {data['Company_Name']}!")

          if __name__ == "__main__":
              asyncio.run(sync_to_notion())
          SCRIPT_EOF

      - name: Sync to Notion
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        run: |
          python sync_company.py "${{ inputs.company }}"

      - name: Summary
        run: |
          echo "‚úÖ Successfully synced ${{ inputs.company }} to Notion"
          echo "Check your Notion database: https://notion.so/2861bdff7e998000a14edb0bf56a75bf"
